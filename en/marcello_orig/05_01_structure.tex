\section{Simulator Structure} \label{sec:sim_struct}

We have chosen the \acs{NS-Miracle} simulator \cite{NSMiracle} as it is an open source project and it offers a wide set of network protocols already implemented and accurately tested, a feature-rich \acs{IEEE} 802.11b/g \ac{MAC} layer and detailed physical layers with multiple propagation models. 

We implement with this simulator the \ac{WLAN} communication between different devices and the \ac{WSN} nodes that detect the channel status. The protocol stack for our simulations (Figure \ref{fig:sim_stack}) starts at the bottom of the protocol stack with a simple \ac{WLAN} channel model that only add the small propagation delay for the speed of light. Then the signal is received from (or emitted to) the channel by the physical layer for both of the \ac{WLAN} and the \ac{WSN} nodes. In this layer we can choose different propagation models such as simple-path loss\footnote{\texttt{Propagation/SimplePathLoss}}, two-ray Rayleigh fading\footnote{\texttt{Propagation/MrclTwoRayGround}}, and shadowing\footnote{\texttt{MPropagation/FullPropagation}}.

\begin{figure}[htb]
	\begin{center}
		\scalebox{0.75}{\input{images/wlan-wsn_stack.tex}}
	\end{center}
	\caption{Protocol Stacks in the simulator for the \ac{WLAN} and the \ac{WSN}.}
	\label{fig:sim_stack}
\end{figure}

In the \ac{WLAN} nodes the frame is forwarded to the \ac{MAC} layer where it is decoded. We choose to use the \texttt{dei80211mr} module which provides enhanced functionality as well as some bug fixing of the \acs{NS}'s \ac{MAC} implementation \cite{dei80211mr}. The network layer is based on the combination of two modules for enabling the nodes to have an \acs{IP} address and the basic routing protocols. Then we have a simple transport layer, consisting of a module that adds ports to handle multiple connections, without requiring the inclusion of the \acs{TCP} or \acs{UDP} protocols. In this way, we remove the protocol related constraints for the upper session layer that handles the traffic generation described in the following section.

On the other hand, the \ac{WSN} nodes receive the bits from the common channel using the same physical layer class. Changing in this layer the threshold level, below of which the packet is dropped, means that we can directly increase or decrease the detection range. If the frame passes this threshold test, it is forwarded to the next layers that represent the physical sensor and the model estimation processes described in chapters \ref{sec:global} and \ref{sec:local}. These modules are part of our contribution and they are described in detail in the section \ref{sec:sim_estimation}.

\subsection{Traffic Generation} \label{sec:sim_traffic}

We provide the simulator with a top layer for traffic generation that completely differs from the ones included in the packages of \acs{NS} and \acs{NS-Miracle}. The simulator offered \ac{CBR} or application specific traffic generators but our goal is to evaluate more general scenarios. Therefore we implement the hierarchical traffic model proposed in \cite{Campus-WLAN} including users, sessions, and flows. %  we are interested only in the effects of the \ac{WLAN} communication to the spectrum activity, we need a more generic way to inject packets into the simulator that should cover almost every scenario.

Thus we developed the session layer in the protocol stack in Figure \ref{fig:sim_stack} to randomly generate packets according to various parameters, modeling different aspects of the user activity. This layer consists of different levels and each describes a deeper aspect of the communication generated by the user. The higher levels are handled in a \texttt{Session} class, while the lower packet generation level is provided by a dynamic shared object.

To employ the randomization in each layer we also include a set of random number generators in the same dynamic shared object, that use the functions from the \ac{GSL} \cite{GSL}. We provide the following parametrized distributions:
\begin{itemize}
	\item Uniform;
	\item Exponential;
	\item Log-normal;
	\item Truncated Gaussian;
	\item Poisson;
	\item Generalized Pareto;
	\item Bi-Pareto \cite{Nuzman2002};
	\item Mixture Generalized Pareto with Uniform \cite{DSA-Emp}.
\end{itemize}

\subsubsection{Session.tcl}

The whole \texttt{Session} class is described in a single file using the \acs{OTcl} programming language, to allow the developers to easily manage those higher levels, including or excluding them from the simulation.

\begin{figure}[htb]
	\begin{center}
		\scalebox{0.75}{\input{images/session.tex}}
	\end{center}
	\caption{Application layer of the \ac{WLAN}: session level.}
	\label{fig:wlan_session}
\end{figure}

The \textit{session} is assigned to a single \ac{WLAN} device located somewhere in the simulation area and it represents a user that associates to an \ac{AP} and starts to generate traffic as required. It is unlikely that multiple users in \ac{WLAN} connect simultaneously but, instead, they follow some kind of arrival process that is shown in Figure \ref{fig:wlan_session}. Thus, we provide a way to associate a parametrized random distribution and its values will describe the sequence of session arrivals.

\begin{figure}[htb]
	\begin{center}
		\scalebox{0.75}{\input{images/session_flow.tex}}
	\end{center}
	\caption{Single sessions of the \ac{WLAN}: flow level.}
	\label{fig:wlan_flow}
\end{figure}

In each session, the user will generate different \textit{flows} according to the usage of various applications. Thus, a single flow represents a data connection between the two ends and it has its own arrival time and size as depicted in Figure \ref{fig:wlan_flow}. The number of flows, the inter-arrival process and the size of each flow are variables that could be assigned with the values coming from different distributions, configured globally or locally at each \ac{WLAN} user. 

\subsubsection{PacketFlow.cc}

In addition to the random number generators the dynamic shared object contains the \acs{NS-Miracle} module for handling the lower layer that is a single flow and it is called \texttt{Module/PacketFlow}. We could not provide this layer in the same way as the higher levels in \acs{OTcl}, due to the structure of the simulator: we must use the internal code to generate packets and send them quickly to the lower network layer.

\begin{figure}[htb]
	\begin{center}
		\scalebox{0.75}{\input{images/session_packets.tex}}
	\end{center}
	\caption{Single flow of the \ac{WLAN}: packet level.}
	\label{fig:wlan_packet}
\end{figure}

Since the flow consists of a single connection between two ends, it contains the sequence of the packets for that communication. The packets inside the flow are regulated by the values retrieved from the distribution of packet inter-arrivals and sizes as shown in figure \ref{fig:wlan_packet}. The flow could be configured also as \textit{full duplex}, that is each packet reception at the other end triggers a generation of a reply packet.

This characterization of the \ac{WLAN} user's sessions give us the possibility not only to implement the complex traffic model described in \cite{Campus-WLAN}, but also to provide a general framework that offers multiple customizable options for traffic generation, while decoupling the process from the traffic or application type.

\subsection{Estimation Library} \label{sec:sim_estimation}

We also provide an executable and also dynamic shared object that contains all the functions for parameter estimation that have been used in the previous chapters. We could, hence, run parameter estimation and neural network training/testing not only off-line but also directly inside the simulator.

This library includes also the two modules for the \ac{WSN} protocol stack in the \acs{NS-Miracle} simulator, as shown in Figure \ref{fig:sim_stack}. First of all we need a module that enables us to sense the spectrum status, providing a solid interface for the upper module that will use the sensor to estimate the model parameters.

\subsubsection{Module/PhySensor}

This module represents the physical sensor used for \ac{WLAN} channel activity measurement inside the \ac{WSN} node. Generally, the sensors report the spectrum status through queries, but we also include the feature of returning a sequence of idle and active period samples for the measurement process.

To provide the sensing functionality we need to maintain a memory for the timestamp of the last received packet and its duration, since the \acs{NS-Miracle} is an event-driven simulator that generates events only on the beginning of a packet reception by any station.

\begin{figure}[htb]
	\begin{center}
		\scalebox{0.75}{\input{images/physensor.tex}}
	\end{center}
	\caption{Timestamp holding solves the problem of lost channel status.}
	\label{fig:ns_memory}
\end{figure}

The figure \ref{fig:ns_memory} summarizes the problem: the event is generated a time $e$, but there should be an effect at time $s_1$ or $s_2$ when the sensor is sensing. To achieve this, we need to implement a local channel status at each sensor. Thus for each sensor, at each packet arrival $e$ we save this timestamp and we consider the channel occupied for the transmission length, even if the node itself is not active at the beginning of the packet transmission.

\subsubsection{Models}

In addition, we developed a set of modules that use the provided physical sensor to build the channel activity models for the global or local view. All the modules descend from a common superclass called \texttt{ModelView} that defines the skeleton for the derived modules and describe some basic common functions.

This modules do not actually belong to a proper network stack for \ac{WSN}, since there is no packet exchange between them and the lower connected physical sensor. Instead, they are linked to the interface provided by the sensor for querying and executing the continuous measurement process, allowing the system to run asynchronously with respect the packet events.

The set contains for both the local and the global view, different types of functions as follows:
\begin{itemize}
	\item \texttt{Model/GlobalView} and \texttt{Model/LocalView} are the basic modules that estimate the parameters of the respective modules;
	\item \texttt{Model/EmpiricalGlobalView} and \texttt{Model/EmpiricalLocalView} are modules that also compare the distributions estimated with the empirical ones;
	\item \texttt{Model/KSGlobalView} and \texttt{Model/KSLocalView} are instead modules that, after the estimation, execute also the Kolmorogov-Smirov test \cite{Massey1951} for evaluating the goodness-of-fit of the distribution with the empirical ones.
\end{itemize}

